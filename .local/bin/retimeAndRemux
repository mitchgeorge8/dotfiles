#!/bin/bash

for file in *.mkv 
do
  i=${file%.mkv}

  if [ -f "$i.srt" ]; then
		auto_retime=false
		offset=-1
		eng_sub_track=1
		jpn_aud_track=1

		# Remove audio tracks other than Japanese, if they exist
		mkvmerge -o "$i-temp1.mkv" -a jpn "$i.mkv"

		# Remove any other Japanese audio tracks, if there are more than one
		mkvmerge -o "$i-temp2.mkv" -a $jpn_aud_track "$i-temp1.mkv"

		if [ "$auto_retime" = true ]; then
    	# Extract existing sub file from video, should be timed correctly
    	ffmpeg -i "$i.mkv" -map 0:s:$eng_sub_track "$i-temp1.srt"

    	# Remove all formatting to prevent errors in alass
    	ffmpeg -i "$i-temp1.srt" -c:s srt -map 0:s:0 "$i-temp2.srt"

    	# Use extracted reference sub to retime target sub
    	alass "$i-temp2.srt" "$i.srt" "$i-temp3.srt"
			rm "$i.srt"

			# Shift the target sub using the original video file
    	alass "$i.mkv" "$i-temp3.srt" "$i.srt" --no-split

			# Clean up
			rm "$i-temp1.srt"
			rm "$i-temp2.srt"
			rm "$i-temp3.srt"
		else
			# Retime manually by fixed amount
			ffmpeg -itsoffset $offset -i "$i.srt" "$i-temp1.srt"
			rm "$i.srt"

			# Remove all formatting
    	ffmpeg -i "$i-temp1.srt" -c:s srt -map 0:s:0 "$i.srt"
			rm "$i-temp1.srt"
		fi

    # Remove existing attachments from video file to decrease file size
		mkvmerge -o "$i-temp3.mkv" -s $((eng_sub_track + 1)) --no-attachments --no-global-tags "$i-temp2.mkv"
  
    # Mux video and subtitle files
    mkvmerge -o "$i-temp4.mkv" "$i.srt" "$i-temp3.mkv" --title "$i"
  
    # Delete original video and sub files
    rm "$i.mkv"
    rm "$i.srt"
    rm "$i-retimed.srt"
  
    # Set langauge tags and make Japanese default
    mkvmerge -o "$i.mkv" --language 0:jpn --language 1:jpn --language 2:jpn --language 3:eng --track-name 0:"$i" --track-name 1:Japanese --track-name 2:Japanese --track-name 3:English --default-track-flag 2 --default-track-flag 3:0 --forced-display-flag 3:0 "$i-temp4.mkv"
  
    # Clean up
    rm "$i-temp1.mkv"
    rm "$i-temp2.mkv"
		rm "$i-temp3.mkv"
		rm "$i-temp4.mkv"
  else
    echo "No matching subtitle file found for '$i.mkv'"
  fi
done
