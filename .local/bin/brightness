#!/bin/bash

bus=0
temp="/tmp/brightness"
step=1
signal=8

if ! ddcutil ; then
	exit
fi

if [ ! -f $temp ]; then
	current=$(ddcutil --bus $bus --sleep-multiplier 0 getvcp 10 -t)
	current=${current:9:-4}
	echo $current > $temp
else
	current=$(cat $temp)
fi

if [[ "$1" == "up" ]]; then
	new=$((current + step > 100 ? 100 : current + step))
elif [[ "$1" == "down" ]]; then
	new=$((current - step < 0 ? 0 : current - step))
elif [[ "$1" == "max" ]]; then
	new=100
elif [[ "$1" == "min" ]]; then
	new=0
elif [[ "$1" == "set" ]]; then
	new=$2
else
	new=$current
fi

echo "{\"percentage\":${new},\"tooltip\":\"Brightness\"}"
pkill -RTMIN+$signal waybar

if [ "$new" -ne "$current" ]; then
	pkill -f "ddcutil.*setvcp 10"
	(ddcutil --bus $bus --sleep-multiplier 0 setvcp 10 $new) &
	echo $new > $temp
fi
